<!-- Generated by SpecStory -->

# 交易所页面重复请求问题 (2025-05-24 15:19:01)

_**User**_

帮我解决交易所页面，为什么首次进入会发送三次重复请求

---

_**Assistant**_



---

我看到您提供的代码是银行卡申请页面，但您问的是交易所页面的重复请求问题。让我先搜索交易所相关的页面代码来定位问题。

---

<details>
            <summary>Searched codebase "交易所页面 首次进入 请求" • **25** results</summary>
        
| File | Lines |
|------|-------|
| `src/pages/trading/exchange.vue` | L835-899 |
| `src/pages/trading/exchange.vue` | L585-631 |
| `src/pages/trading/index.vue` | L245-342 |
| `src/pages/trading/index.vue` | L1-76 |
| `src/pages/trading/exchange.vue` | L758-835 |
| `src/pages/trading/exchange.vue` | L1-55 |
| `src/pages/trading/exchange.vue` | L421-468 |
| `src/pages/trading/exchange.vue` | L631-706 |
| `src/pages/trading/exchange.vue` | L468-517 |
| `src/pages/trading/index.vue` | L76-161 |
| `src/pages/trading/exchange.vue` | L372-421 |
| `src/pages/trading/exchange.vue` | L899-978 |
| `src/pages/assets/components/CurrencyTab.vue` | L291-358 |
| `src/pages/trading/exchange.vue` | L706-758 |
| `src/pages/trading/exchange.vue` | L336-372 |
| `src/pages/assets/index.vue` | L549-614 |
| `src/pages/assets/components/CurrencyTab.vue` | L236-291 |
| `src/pages/trading/exchange.vue` | L295-336 |
| `src/pages/trading/exchange.vue` | L215-295 |
| `src/pages/trading/trade-detail.vue` | L510-580 |
| `src/pages/trading/trade-detail.vue` | L109-163 |
| `src/pages/trading/index.vue` | L161-190 |
| `src/pages/trading/exchange.vue` | L517-585 |
| `src/pages/trading/trade-detail.vue` | L163-209 |
| `src/pages/trading/index.vue` | L190-245 |

</details>

---

让我继续搜索更多相关的代码，特别是关于生命周期和初始化的部分：

---

<details>
            <summary>Grep search for "onMounted|onShow|onLoad" • **2** files</summary>
        
| File | Line | Match |
|------|------|-------|
| `file:///home/xchenxiao/Development/trade_main/unibest_base/src/pages/trading/exchange.vue` | L213 | `import { ref, reactive, computed, onMounted, onUnmounted, watch, toRefs } from 'vue'` |
| `file:///home/xchenxiao/Development/trade_main/unibest_base/src/pages/trading/exchange.vue` | L214 | `import { onShow } from '@dcloudio/uni-app'` |
| `file:///home/xchenxiao/Development/trade_main/unibest_base/src/pages/trading/exchange.vue` | L851 | `onShow(() => {` |
| `file:///home/xchenxiao/Development/trade_main/unibest_base/src/pages/trading/exchange.vue` | L878 | `onMounted(async () => {` |
| `file:///home/xchenxiao/Development/trade_main/unibest_base/src/pages/trading/exchange.vue` | L213 | `import { ref, reactive, computed, onMounted, onUnmounted, watch, toRefs } from 'vue'` |
| `file:///home/xchenxiao/Development/trade_main/unibest_base/src/pages/trading/exchange.vue` | L214 | `import { onShow } from '@dcloudio/uni-app'` |
| `file:///home/xchenxiao/Development/trade_main/unibest_base/src/pages/trading/exchange.vue` | L851 | `onShow(() => {` |
| `file:///home/xchenxiao/Development/trade_main/unibest_base/src/pages/trading/exchange.vue` | L878 | `onMounted(async () => {` |

</details>

---

现在让我查看交易所页面的生命周期部分的详细代码：

---

Read file: src/pages/trading/exchange.vue

---

现在让我查看 `useTabItemTap` 这个钩子的代码，它可能也在触发请求：

---

<details>
            <summary>Searched codebase "useTabItemTap" • **25** results</summary>
        
| File | Lines |
|------|-------|
| `src/hooks/useTabItemTap.ts` | L58-103 |
| `src/hooks/useTabItemTap.ts` | L1-58 |
| `src/pages/trading/exchange.vue` | L835-899 |
| `src/components/fg-tabbar/fg-tabbar.vue` | L1-54 |
| `src/utils/index.ts` | L10-24 |
| `src/components/fg-tabbar/fg-tabbar.vue` | L54-100 |
| `src/components/fg-tabbar/tabbar.ts` | L1-14 |
| `src/document/trading-page.txt` | L54-93 |
| `src/pages/assets/components/CurrencyTab.vue` | L236-291 |
| `src/types/auto-import.d.ts` | L177-188 |
| `src/pages/assets/index.vue` | L1-81 |
| `src/layouts/tabbar.vue` | L1-20 |
| `src/types/uni-pages.d.ts` | L46-50 |
| `src/pages/team/index.vue` | L1-47 |
| `src/pages/assets/components/CurrencyTab.vue` | L291-358 |
| `src/pages/trading/exchange.vue` | L215-295 |
| `pages.config.ts` | L1-61 |
| `src/document/assets-page.txt` | L44-87 |
| `src/pages.json` | L1-57 |
| `src/pages/index/index.vue` | L1-61 |
| `src/pages/trading/exchange.vue` | L758-835 |
| `src/document/assets-page.txt` | L571-690 |
| `src/utils/index.ts` | L1-10 |
| `src/types/uni-pages.d.ts` | L52-59 |
| `src/types/auto-import.d.ts` | L66-101 |

</details>

---

通过分析代码，我发现了交易所页面首次进入会发送三次重复请求的问题。问题主要出现在 `src/pages/trading/exchange.vue` 页面中。让我来解释一下问题的根本原因和解决方案：

## 问题根源分析

交易所页面存在三个不同的生命周期钩子和回调，它们都在触发相同的数据请求：

1. **`useTabItemTap` 钩子的 `onTabTap` 回调** - 当切换到交易所Tab时触发
2. **`onShow` 生命周期钩子** - 页面显示时触发
3. **`onMounted` 生命周期钩子** - 页面挂载时触发

这三个钩子在首次进入页面时会几乎同时执行，导致发送三次重复的API请求。

## 解决方案

我将修改交易所页面代码，添加一个初始化状态控制和防重复请求机制：

---

```diff
  // 下拉刷新状态
  const refreshing = ref(false)
+ // 页面初始化状态
+ const isInitialized = ref(false)
+ // 数据请求防抖状态
+ const requestingData = ref(false)
  
  // 图表时间周期
```

```diff
    }
  }
+ 
+ // 防重复请求的数据获取方法
+ const fetchDataWithDebounce = async () => {
+   // 如果已经在请求数据，则跳过
+   if (requestingData.value) {
+     console.log('数据请求正在进行中，跳过重复请求')
+     return
+   }
+ 
+   requestingData.value = true
+   try {
+     // 根据当前选中的标签刷新对应数据
+     if (activeTab.value === 'currency') {
+       // 清空当前货币列表，重新获取交易订单数据
+       currencies.length = 0
+       await fetchCurrencyOrders()
+     } else {
+       await fetchEquityData()
+     }
+   } finally {
+     requestingData.value = false
+   }
+ }
  
  // 使用TabBar切换钩子，自动刷新交易所数据
```

```diff
    onTabTap: () => {
      console.log('交易所页面Tab被点击，刷新当前选中的数据')
+     // 如果页面未初始化，跳过Tab点击触发的请求
+     if (!isInitialized.value) {
+       console.log('页面未初始化完成，跳过Tab点击触发的数据请求')
+       return
+     }
      // 不再从store刷新用户信息，而是直接使用已有数据
      // 根据当前选中的标签刷新对应数据
-     if (activeTab.value === 'currency') {
-       fetchCurrencyOrders()
-     } else {
-       fetchEquityData()
-     }
+     fetchDataWithDebounce()
    },
  })
```

```diff
  onShow(() => {
    console.log('交易所页面显示，开始刷新数据')
+ 
+   // 如果页面未初始化，跳过onShow触发的请求
+   if (!isInitialized.value) {
+     console.log('页面未初始化完成，跳过onShow触发的数据请求')
+     return
+   }
  
    // 异步刷新数据
```

```diff
      console.log('使用现有的用户货币缓存数据，不强制刷新')
  
-     // 根据当前选中的标签刷新对应数据
-     if (activeTab.value === 'currency') {
-       // 清空当前货币列表，重新获取交易订单数据
-       currencies.length = 0
-       await fetchCurrencyOrders()
-     } else {
-       await fetchEquityData()
-     }
+     await fetchDataWithDebounce()
  
      console.log('交易所页面数据刷新完成')
```

```diff
  // 页面加载时获取数据
  onMounted(async () => {
+   console.log('交易所页面开始初始化')
+   
    // 从store获取用户信息，但不强制刷新
    await userInfoStore.getUserCompleteInfo(false)
```

```diff
    }
  
+   // 执行初始数据获取
    if (activeTab.value === 'currency') {
      currencies.length = 0
-     fetchCurrencyOrders()
+     await fetchCurrencyOrders()
    } else {
-     fetchEquityData()
+     await fetchEquityData()
    }
+ 
+   // 标记页面初始化完成
+   isInitialized.value = true
+   console.log('交易所页面初始化完成')
  })
  
```

---

现在让我们也修复下拉刷新方法，使其使用新的防重复机制：

---

```diff
      await refreshUserCurrencies()
  
-     if (activeTab.value === 'currency') {
-       currencies.length = 0
-       await fetchCurrencyOrders()
-     } else {
-       await fetchEquityData()
-     }
+     // 使用防重复的数据获取方法
+     await fetchDataWithDebounce()
  
      // 刷新成功提示
```

---

现在让我们也优化一下刷新数据的方法，使其也使用防重复机制：

---

```diff
  const refreshData = () => {
    console.log('交易所页面刷新数据')
-   if (activeTab.value === 'currency') {
-     currencies.length = 0
-     fetchCurrencyOrders()
-   } else {
-     fetchEquityData()
-   }
+   // 如果页面未初始化，跳过外部调用的请求
+   if (!isInitialized.value) {
+     console.log('页面未初始化完成，跳过外部调用的数据请求')
+     return
+   }
+   fetchDataWithDebounce()
  }
  
```

---

让我们也修改切换标签的方法，确保它们也使用防重复机制：

---

```diff
  const switchTab = (tab: string) => {
    // 如果正在加载数据，则不允许切换标签
-   if (loading.value) {
+   if (loading.value || requestingData.value) {
      uni.showToast({
        title: '正在加载数据，请稍候...',
```

```diff
    if (activeTab.value !== tab) {
      activeTab.value = tab
-     if (tab === 'equity') {
-       fetchEquityData()
-     } else {
-       // 切换到货币标签时先清空货币列表，再刷新货币订单
-       currencies.length = 0
-       fetchCurrencyOrders()
+     // 如果页面已初始化，才执行数据获取
+     if (isInitialized.value) {
+       fetchDataWithDebounce()
      }
    }
```

```diff
  const switchCurrencyTab = (tab: string) => {
    // 如果正在加载数据，则不允许切换标签
-   if (loading.value) {
+   if (loading.value || requestingData.value) {
      uni.showToast({
        title: '正在加载数据，请稍候...',
```

```diff
    if (activeCurrencyTab.value !== tab) {
      activeCurrencyTab.value = tab
+     // 如果页面已初始化，才执行数据获取
+     if (isInitialized.value) {
        // 切换标签时先清空货币列表，再重新获取货币订单
        currencies.length = 0
-     fetchCurrencyOrders()
+       fetchDataWithDebounce()
+     }
    }
  }
```

---

现在让我们检查一下修改后的文件，确保所有代码都正确应用了：

---

Read file: src/pages/trading/exchange.vue

---

让我看看防重复请求的方法是否正确添加：

---

<details>
            <summary>Grep search for "fetchDataWithDebounce" • **2** files</summary>
        
| File | Line | Match |
|------|------|-------|
| `file:///home/xchenxiao/Development/trade_main/unibest_base/src/pages/trading/exchange.vue` | L672 | `fetchDataWithDebounce()` |
| `file:///home/xchenxiao/Development/trade_main/unibest_base/src/pages/trading/exchange.vue` | L696 | `fetchDataWithDebounce()` |
| `file:///home/xchenxiao/Development/trade_main/unibest_base/src/pages/trading/exchange.vue` | L838 | `const fetchDataWithDebounce = async () => {` |
| `file:///home/xchenxiao/Development/trade_main/unibest_base/src/pages/trading/exchange.vue` | L874 | `fetchDataWithDebounce()` |
| `file:///home/xchenxiao/Development/trade_main/unibest_base/src/pages/trading/exchange.vue` | L893 | `await fetchDataWithDebounce()` |
| `file:///home/xchenxiao/Development/trade_main/unibest_base/src/pages/trading/exchange.vue` | L940 | `fetchDataWithDebounce()` |
| `file:///home/xchenxiao/Development/trade_main/unibest_base/src/pages/trading/exchange.vue` | L961 | `await fetchDataWithDebounce()` |
| `file:///home/xchenxiao/Development/trade_main/unibest_base/src/pages/trading/exchange.vue` | L672 | `fetchDataWithDebounce()` |
| `file:///home/xchenxiao/Development/trade_main/unibest_base/src/pages/trading/exchange.vue` | L696 | `fetchDataWithDebounce()` |
| `file:///home/xchenxiao/Development/trade_main/unibest_base/src/pages/trading/exchange.vue` | L838 | `const fetchDataWithDebounce = async () => {` |
| `file:///home/xchenxiao/Development/trade_main/unibest_base/src/pages/trading/exchange.vue` | L874 | `fetchDataWithDebounce()` |
| `file:///home/xchenxiao/Development/trade_main/unibest_base/src/pages/trading/exchange.vue` | L893 | `await fetchDataWithDebounce()` |
| `file:///home/xchenxiao/Development/trade_main/unibest_base/src/pages/trading/exchange.vue` | L940 | `fetchDataWithDebounce()` |
| `file:///home/xchenxiao/Development/trade_main/unibest_base/src/pages/trading/exchange.vue` | L961 | `await fetchDataWithDebounce()` |

</details>

---

看起来 `fetchDataWithDebounce` 方法被正确添加并使用了。现在让我们检查这个方法的具体实现：

---

Read file: src/pages/trading/exchange.vue

---

完美！现在让我们总结一下解决方案：

## 🔧 解决方案总结

我已经成功修复了交易所页面首次进入时发送三次重复请求的问题。以下是具体的修改：

### 1. **添加状态控制变量**
```javascript
// 页面初始化状态
const isInitialized = ref(false)
// 数据请求防抖状态
const requestingData = ref(false)
```

### 2. **创建防重复请求方法**
```javascript
const fetchDataWithDebounce = async () => {
  // 如果已经在请求数据，则跳过
  if (requestingData.value) {
    console.log('数据请求正在进行中，跳过重复请求')
    return
  }
  
  requestingData.value = true
  try {
    // 根据当前选中的标签刷新对应数据
    if (activeTab.value === 'currency') {
      currencies.length = 0
      await fetchCurrencyOrders()
    } else {
      await fetchEquityData()
    }
  } finally {
    requestingData.value = false
  }
}
```

### 3. **修改生命周期钩子**
- **`onMounted`**: 只在页面初次加载时执行数据获取，完成后设置 `isInitialized = true`
- **`onShow`**: 检查页面是否已初始化，未初始化则跳过请求
- **`useTabItemTap`**: 检查页面是否已初始化，未初始化则跳过请求

### 4. **优化其他相关方法**
- 修改 `switchTab` 和 `switchCurrencyTab` 方法，添加初始化状态检查
- 修改 `refreshData` 方法，使用防重复机制
- 修改 `onRefresh` 下

---

