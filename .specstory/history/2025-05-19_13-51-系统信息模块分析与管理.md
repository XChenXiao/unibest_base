<!-- Generated by SpecStory -->

# 系统信息模块分析与管理 (2025-05-19 21:51:36)

_**User**_

帮我分析该系统中关于用于信息有哪些模块，然后创建对应的pina用于存储和管理

---

_**Assistant**_



---

让我先了解系统结构，特别是与用户信息相关的模块。

---

<details>
            <summary>Listed current directory • **40** results</summary>
        
| Name |
|-------|
| 📁 `.git` |
| 📄 `.eslintrc-auto-import.json` |
| 📄 `package.json` |
| 📄 `build-success.log` |
| 📄 `build-error.log` |
| 📄 `manifest.config.ts` |
| 📁 `src` |
| 📁 `env` |
| 📄 `.cursorignore` |
| 📁 `dist` |
| 📁 `node_modules` |
| 📄 `openapi-ts-request.config.ts` |
| 📄 `.gitignore` |
| 📄 `.cursorindexingignore` |
| 📁 `.specstory` |
| 📄 `pages.config.ts` |
| 📄 `vite.config.ts` |
| 📄 `pnpm-lock.yaml` |
| 📄 `README.md` |
| 📁 `.husky` |
| 📄 `tsconfig.json` |
| 📄 `uno.config.ts` |
| 📁 `vite-plugins` |
| 📁 `scripts` |
| 📁 `screenshots` |
| 📄 `index.html` |
| 📄 `.npmrc` |
| 📄 `.prettierignore` |
| 📄 `.prettierrc.cjs` |
| 📄 `.stylelintignore` |
| 📄 `.stylelintrc.cjs` |
| 📁 `.vscode` |
| 📄 `LICENSE` |
| 📄 `favicon.ico` |
| 📄 `.commitlintrc.cjs` |
| 📁 `.cursor` |
| 📄 `.editorconfig` |
| 📄 `.eslintignore` |
| 📄 `.eslintrc.cjs` |
| 📁 `.github` |

</details>

---

接下来我需要查看src目录，这是代码的主要部分：

---

<details>
            <summary>Listed directory src • **24** results</summary>
        
| Name |
|-------|
| 📁 `document` |
| 📄 `pages.json` |
| 📄 `manifest.json` |
| 📄 `App.vue` |
| 📁 `store` |
| 📁 `utils` |
| 📁 `components` |
| 📁 `pages` |
| 📁 `static` |
| 📁 `service` |
| 📁 `types` |
| 📁 `uni_modules` |
| 📁 `config` |
| 📄 `typings.d.ts` |
| 📁 `interceptors` |
| 📁 `mock` |
| 📄 `env.d.ts` |
| 📁 `hooks` |
| 📄 `typings.ts` |
| 📄 `uni.scss` |
| 📁 `style` |
| 📁 `layouts` |
| 📄 `main.ts` |
| 📁 `pages-sub` |

</details>

---

我看到有一个store目录，这可能是存放Pinia相关的状态管理。让我查看一下：

---

<details>
            <summary>Listed directory src/store • **4** results</summary>
        
| Name |
|-------|
| 📄 `index.ts` |
| 📄 `platform.ts` |
| 📄 `app.ts` |
| 📄 `user.ts` |

</details>

---

很好，我已经找到了user.ts文件，这应该包含与用户信息相关的状态管理。让我查看一下这个文件的内容：

---

Read file: src/store/user.ts

---

我需要了解系统中还有哪些与用户信息相关的模块。查看一下服务接口层，看看有没有用户相关的API定义：

---

<details>
            <summary>Listed directory src/service • **4** results</summary>
        
| Name |
|-------|
| 📁 `index` |
| 📁 `app` |
| 📄 `app.ts` |
| 📄 `index.ts` |

</details>

---

让我查看一下index文件夹，那里可能有用户相关的API：

---

<details>
            <summary>Listed directory src/service/index • **11** results</summary>
        
| Name |
|-------|
| 📄 `bankcard.ts` |
| 📄 `platform.ts` |
| 📄 `withdraw.ts` |
| 📄 `message.ts` |
| 📄 `rewards.ts` |
| 📄 `team.ts` |
| 📄 `index.ts` |
| 📄 `verification.ts` |
| 📄 `auth.ts` |
| 📄 `checkin.ts` |
| 📄 `foo.ts` |

</details>

---

我看到了几个可能与用户信息相关的文件：auth.ts、verification.ts、bankcard.ts、team.ts等。让我先查看auth.ts文件：

---

Read file: src/service/index/auth.ts

---

接下来看看verification.ts文件，了解用户认证相关信息：

---

Read file: src/service/index/verification.ts

---

查看一下team.ts文件，了解团队相关的用户信息：

---

Read file: src/service/index/team.ts

---

查看一下bankcard.ts文件，了解用户银行卡信息：

---

Read file: src/service/index/bankcard.ts

---

查看一下message.ts文件，了解用户消息相关的信息：

---

Read file: src/service/index/message.ts

---

基于上述分析，我现在了解了系统中与用户信息相关的主要模块。让我创建一个全面的Pinia store来存储和管理用户信息：

---

```diff
- 
+ import { defineStore } from 'pinia'
+ import { ref, computed } from 'vue'
+ import { 
+   getUserInfoAPI, 
+   loginAPI, 
+   logoutAPI, 
+   registerAPI 
+ } from '@/service/index/auth'
+ import { 
+   getVerificationStatusAPI, 
+   IVerificationStatus 
+ } from '@/service/index/verification'
+ import { 
+   checkBankCardStatusAPI,
+   getBankCardsAPI,
+   IBankCard 
+ } from '@/service/index/bankcard'
+ import { 
+   getTeamInfoAPI, 
+   getTeamStatsAPI 
+ } from '@/service/index/team'
+ import { 
+   getUnreadAnnouncementCountAPI 
+ } from '@/service/index/message'
+ 
+ // 用户基本信息接口
+ export interface IUserInfo {
+   id?: number
+   name: string
+   phone: string
+   email: string
+   token: string
+   balance: number
+   frozen_balance: number
+   equity_balance: number
+   invite_code: string
+   referrer_invite_code: string
+   has_bank_card: boolean
+   avatar?: string
+   created_at?: string
+   updated_at?: string
+ }
+ 
+ // 用户认证状态接口
+ export interface IVerificationInfo {
+   verified: boolean
+   pending: boolean
+   rejected: boolean
+   rejection_reason: string
+   real_name?: string
+   id_card_number?: string
+ }
+ 
+ // 银行卡状态枚举
+ export enum BankCardStatus {
+   NONE = 'none',             // 未申请
+   APPLYING = 'applying',     // 申请中
+   REVIEWING = 'reviewing',   // 审核中
+   APPROVED = 'approved',     // 已审核通过
+   REJECTED = 'rejected'      // 审核拒绝
+ }
+ 
+ // 团队信息接口
+ export interface ITeamInfo {
+   total_members: number
+   direct_invites: number
+   verified_members: number
+   total_rewards: number
+ }
+ 
+ // 消息通知接口
+ export interface IMessageInfo {
+   unread_count: number
+   personal_unread: number
+   global_unread: number
+ }
+ 
+ // 初始用户信息状态
+ const initUserInfo: IUserInfo = { 
+   name: '',
+   phone: '',
+   email: '',
+   token: '',
+   balance: 0,
+   frozen_balance: 0,
+   equity_balance: 0,
+   invite_code: '',
+   referrer_invite_code: '',
+   has_bank_card: false
+ }
+ 
+ // 初始认证信息状态
+ const initVerificationInfo: IVerificationInfo = {
+   verified: false,
+   pending: false,
+   rejected: false,
+   rejection_reason: ''
+ }
+ 
+ // 初始团队信息状态
+ const initTeamInfo: ITeamInfo = {
+   total_members: 0,
+   direct_invites: 0,
+   verified_members: 0,
+   total_rewards: 0
+ }
+ 
+ // 初始消息信息状态
+ const initMessageInfo: IMessageInfo = {
+   unread_count: 0,
+   personal_unread: 0,
+   global_unread: 0
+ }
+ 
+ export const useUserInfoStore = defineStore(
+   'userInfo',
+   () => {
+     // 用户基本信息
+     const userInfo = ref<IUserInfo>({ ...initUserInfo })
+     
+     // 用户认证信息
+     const verificationInfo = ref<IVerificationInfo>({ ...initVerificationInfo })
+     
+     // 银行卡状态
+     const bankCardStatus = ref<BankCardStatus>(BankCardStatus.NONE)
+     
+     // 银行卡列表
+     const bankCards = ref<IBankCard[]>([])
+     
+     // 团队信息
+     const teamInfo = ref<ITeamInfo>({ ...initTeamInfo })
+     
+     // 消息信息
+     const messageInfo = ref<IMessageInfo>({ ...initMessageInfo })
+ 
+     // 设置用户信息
+     const setUserInfo = (val: Partial<IUserInfo>) => {
+       userInfo.value = { ...userInfo.value, ...val }
+       // 保存用户信息更新时间
+       uni.setStorageSync('userInfoUpdateTime', Date.now())
+     }
+     
+     // 清除用户信息
+     const clearUserInfo = () => {
+       userInfo.value = { ...initUserInfo }
+       verificationInfo.value = { ...initVerificationInfo }
+       bankCardStatus.value = BankCardStatus.NONE
+       bankCards.value = []
+       teamInfo.value = { ...initTeamInfo }
+       messageInfo.value = { ...initMessageInfo }
+       // 清除本地存储
+       uni.removeStorageSync('userInfoUpdateTime')
+     }
+     
+     // 更新用户余额
+     const updateUserBalance = (newBalance: number, newFrozenBalance?: number, newEquityBalance?: number) => {
+       if (typeof newBalance === 'number') {
+         userInfo.value.balance = newBalance
+       }
+       
+       if (typeof newFrozenBalance === 'number') {
+         userInfo.value.frozen_balance = newFrozenBalance
+       }
+       
+       if (typeof newEquityBalance === 'number') {
+         userInfo.value.equity_balance = newEquityBalance
+       }
+       
+       // 保存用户信息更新时间
+       uni.setStorageSync('userInfoUpdateTime', Date.now())
+     }
+     
+     // 获取用户信息
+     const fetchUserInfo = async () => {
+       if (!userInfo.value.token) {
+         return false
+       }
+       
+       try {
+         const res = await getUserInfoAPI()
+         
+         if (res.status === 'success' && res.data) {
+           // 获取用户数据
+           const userData = res.data.user
+           
+           // 确保余额字段为数字
+           if (userData) {
+             if (userData.balance !== undefined) {
+               userData.balance = Number(userData.balance)
+             }
+             if (userData.frozen_balance !== undefined) {
+               userData.frozen_balance = Number(userData.frozen_balance)
+             }
+             if (userData.equity_balance !== undefined) {
+               userData.equity_balance = Number(userData.equity_balance)
+             }
+           }
+           
+           // 保留token
+           const token = userInfo.value.token
+           
+           // 更新用户信息
+           setUserInfo({ ...userData, token })
+           
+           // 处理实名认证信息
+           const isVerified = res.data.is_verified || false
+           const verificationStatusVal = res.data.verification_status || 'unsubmitted'
+           
+           // 更新认证状态
+           verificationInfo.value = {
+             verified: isVerified,
+             pending: verificationStatusVal === 'pending',
+             rejected: verificationStatusVal === 'rejected',
+             rejection_reason: userData.verification?.remark || '',
+             real_name: userData.verification?.real_name,
+             id_card_number: userData.verification?.id_card_number
+           }
+           
+           return true
+         }
+         
+         return false
+       } catch (error) {
+         console.error('获取用户信息失败', error)
+         return false
+       }
+     }
+     
+     // 获取实名认证状态
+     const fetchVerificationStatus = async () => {
+       if (!userInfo.value.token) {
+         return false
+       }
+       
+       // 已认证用户，跳过请求
+       if (verificationInfo.value.verified) {
+         return true
+       }
+       
+       try {
+         const res = await getVerificationStatusAPI()
+         
+         if (res.status === 'success' && res.data) {
+           const resData = res.data
+           
+           // 更新验证状态
+           verificationInfo.value = {
+             verified: !!resData.is_verified, 
+             pending: resData.verification_status === 'pending',
+             rejected: resData.verification_status === 'rejected',
+             rejection_reason: resData.verification?.remark || '',
+             real_name: resData.verification?.real_name,
+             id_card_number: resData.verification?.id_card_number
+           }
+           
+           return true
+         }
+         
+         return false
+       } catch (error) {
+         console.error('获取实名认证状态失败', error)
+         return false
+       }
+     }
+     
+     // 获取银行卡状态
+     const fetchBankCardStatus = async () => {
+       if (!userInfo.value.token) {
+         return false
+       }
+       
+       try {
+         const res = await checkBankCardStatusAPI()
+         
+         if (res.status === 'success' && res.data) {
+           // 更新用户是否有银行卡
+           setUserInfo({ has_bank_card: !!res.data.has_bank_card })
+           
+           // 设置银行卡状态
+           if (res.data.has_bank_card) {
+             bankCardStatus.value = BankCardStatus.APPROVED
+           } else if (res.data.latest_application) {
+             const status = res.data.latest_application.status
+             switch (status) {
+               case 'pending':
+                 bankCardStatus.value = BankCardStatus.REVIEWING
+                 break
+               case 'completed':
+                 bankCardStatus.value = BankCardStatus.APPROVED
+                 break
+               case 'rejected':
+                 bankCardStatus.value = BankCardStatus.REJECTED
+                 break
+               default:
+                 bankCardStatus.value = BankCardStatus.NONE
+             }
+           } else {
+             bankCardStatus.value = BankCardStatus.NONE
+           }
+           
+           return true
+         }
+         
+         return false
+       } catch (error) {
+         console.error('获取银行卡状态失败', error)
+         return false
+       }
+     }
+     
+     // 获取银行卡列表
+     const fetchBankCards = async () => {
+       if (!userInfo.value.token) {
+         return false
+       }
+       
+       try {
+         const res = await getBankCardsAPI()
+         
+         if (res.status === 'success' && res.data) {
+           bankCards.value = res.data
+           return true
+         }
+         
+         return false
+       } catch (error) {
+         console.error('获取银行卡列表失败', error)
+         return false
+       }
+     }
+     
+     // 获取团队信息
+     const fetchTeamInfo = async () => {
+       if (!userInfo.value.token) {
+         return false
+       }
+       
+       try {
+         // 获取团队统计信息
+         const statsRes = await getTeamStatsAPI()
+         
+         if (statsRes.status === 'success' && statsRes.data) {
+           teamInfo.value = {
+             ...teamInfo.value,
+             total_rewards: Number(statsRes.data.total_rewards || 0),
+             direct_invites: Number(statsRes.data.total_invites || 0)
+           }
+         }
+         
+         // 获取团队详细信息
+         const teamRes = await getTeamInfoAPI()
+         
+         if (teamRes.status === 'success' && teamRes.data) {
+           teamInfo.value = {
+             ...teamInfo.value,
+             total_members: Number(teamRes.data.total_members || 0),
+             verified_members: Number(teamRes.data.verified_members || 0)
+           }
+         }
+         
+         return true
+       } catch (error) {
+         console.error('获取团队信息失败', error)
+         return false
+       }
+     }
+     
+     // 获取未读消息数量
+     const fetchUnreadMessageCount = async () => {
+       if (!userInfo.value.token) {
+         return false
+       }
+       
+       try {
+         const res = await getUnreadAnnouncementCountAPI()
+         
+         if (res && res.unread_count !== undefined) {
+           messageInfo.value = {
+             unread_count: Number(res.unread_count || 0),
+             personal_unread: Number(res.personal_unread || 0),
+             global_unread: Number(res.global_unread || 0)
+           }
+           return true
+         }
+         
+         return false
+       } catch (error) {
+         console.error('获取未读消息数量失败', error)
+         return false
+       }
+     }
+     
+     // 刷新所有用户相关数据
+     const refreshAllUserData = async () => {
+       if (!userInfo.value.token) {
+         return false
+       }
+       
+       try {
+         // 并行获取所有数据
+         await Promise.all([
+           fetchUserInfo(),
+           fetchVerificationStatus(),
+           fetchBankCardStatus(),
+           fetchBankCards(),
+           fetchTeamInfo(),
+           fetchUnreadMessageCount()
+         ])
+         
+         return true
+       } catch (error) {
+         console.error('刷新用户数据失败', error)
+         return false
+       }
+     }
+     
+     // 计算属性：判断用户是否已登录
+     const isLogined = computed(() => !!userInfo.value.token)
+     
+     // 计算属性：判断用户是否通过实名认证
+     const isVerified = computed(() => verificationInfo.value.verified)
+     
+     // 计算属性：判断用户实名认证是否正在审核中
+     const isPendingVerification = computed(() => verificationInfo.value.pending)
+     
+     // 计算属性：判断用户实名认证是否被拒绝
+     const isRejectedVerification = computed(() => verificationInfo.value.rejected)
+     
+     // 计算属性：判断银行卡是否在申请中或审核中
+     const isBankCardProcessing = computed(() => {
+       return bankCardStatus.value === BankCardStatus.APPLYING || 
+              bankCardStatus.value === BankCardStatus.REVIEWING
+     })
+     
+     // 计算属性：获取银行卡状态
+     const getBankCardStatus = computed(() => {
+       // 如果用户已有银行卡，直接返回已审核通过
+       if (userInfo.value.has_bank_card) {
+         return BankCardStatus.APPROVED
+       }
+       // 否则返回当前状态
+       return bankCardStatus.value
+     })
+ 
+     // 计算属性：获取用户有效余额（可用余额 - 冻结余额）
+     const availableBalance = computed(() => {
+       return userInfo.value.balance - userInfo.value.frozen_balance
+     })
+ 
+     return {
+       // 状态
+       userInfo,
+       verificationInfo,
+       bankCardStatus,
+       bankCards,
+       teamInfo,
+       messageInfo,
+       
+       // 方法
+       setUserInfo,
+       clearUserInfo,
+       updateUserBalance,
+       fetchUserInfo,
+       fetchVerificationStatus,
+       fetchBankCardStatus,
+       fetchBankCards,
+       fetchTeamInfo,
+       fetchUnreadMessageCount,
+       refreshAllUserData,
+       
+       // 计算属性
+       isLogined,
+       isVerified,
+       isPendingVerification,
+       isRejectedVerification,
+       isBankCardProcessing,
+       getBankCardStatus,
+       availableBalance
+     }
+   },
+   {
+     persist: {
+       enabled: true,
+       strategies: [
+         {
+           key: 'user-info-store',
+           storage: localStorage,
+           paths: ['userInfo', 'verificationInfo', 'bankCardStatus']
+         }
+       ]
+     }
+   }
+ ) 
```

---

现在我需要修复刚才创建的store中的一些类型错误：

---

Read file: src/service/index/verification.ts

---

Read file: src/service/index/bankcard.ts

---

现在我需要修复类型错误，让我修改userInfo.ts文件：

---

```diff
          
          if (res.status === 'success' && res.data) {
+           // 获取响应数据并进行类型转换
            const resData = res.data
            
```

```diff
              rejection_reason: resData.verification?.remark || '',
              real_name: resData.verification?.real_name,
-             id_card_number: resData.verification?.id_card_number,
+             id_card_number: resData.verification?.id_card_number
            }
            
```

```diff
          
          if (res.status === 'success' && res.data) {
+           // 解构获取数据
+           const { has_bank_card, latest_application } = res.data
+           
            // 更新用户是否有银行卡
-           setUserInfo({ has_bank_card: !!res.data.has_bank_card })
+           setUserInfo({ has_bank_card: !!has_bank_card })
            
            // 设置银行卡状态
-           if (res.data.has_bank_card) {
+           if (has_bank_card) {
              bankCardStatus.value = BankCardStatus.APPROVED
-           } else if (res.data.latest_application) {
-             const status = res.data.latest_application.status
+           } else if (latest_application) {
+             const status = latest_application.status
              switch (status) {
                case 'pending':
```

---

我需要再次调整类型定义，让我修复这些错误：

---

Cancelled

---

需要修复那些类型错误，我们需要更好地定义API接口返回类型：

---



---



---

