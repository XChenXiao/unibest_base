<!-- Generated by SpecStory -->

# 修改银行卡未开通提示逻辑 (2025-06-01 15:54:05)

_**User**_

在交易所的货币卖出以及股权出售中有一个判断逻辑，需要判断是否开通银行卡，如果没有开通我需要修改提示，改成一个确认弹窗指引用户去开通申请界面，逻辑同“我的”页面中点击转入转出时的确认窗口一样

---

_**Assistant**_

我需要先了解项目结构，找到相关的交易所货币卖出和股权出售的代码，以及"我的"页面中转入转出的确认窗口实现。

---

<details>
            <summary>Listed directory src • **24** results</summary>
        
| Name |
|-------|
| 📄 `manifest.json` |
| 📄 `pages.json` |
| 📁 `uni_modules` |
| 📁 `utils` |
| 📁 `types` |
| 📄 `typings.d.ts` |
| 📁 `store` |
| 📁 `static` |
| 📁 `service` |
| 📁 `pages` |
| 📁 `mock` |
| 📁 `interceptors` |
| 📁 `layouts` |
| 📁 `document` |
| 📄 `env.d.ts` |
| 📁 `hooks` |
| 📁 `config` |
| 📁 `components` |
| 📄 `App.vue` |
| 📄 `typings.ts` |
| 📄 `uni.scss` |
| 📁 `style` |
| 📄 `main.ts` |
| 📁 `pages-sub` |

</details>

---

让我先查找与交易所相关的页面，可能在 pages 目录下：

---

<details>
            <summary>Listed directory src/pages • **13** results</summary>
        
| Name |
|-------|
| 📁 `transfer` |
| 📁 `verification` |
| 📁 `webview` |
| 📁 `trading` |
| 📁 `payment` |
| 📁 `register` |
| 📁 `team` |
| 📁 `my` |
| 📁 `index` |
| 📁 `login` |
| 📁 `assets` |
| 📁 `currency-records` |
| 📁 `equity-records` |

</details>

---

我需要查看交易相关的页面，先看看 trading 目录：

---

<details>
            <summary>Listed directory src/pages/trading • **5** results</summary>
        
| Name |
|-------|
| 📄 `trade-detail.vue` |
| 📄 `exchange.vue` |
| 📄 `index.vue` |
| 📄 `股权走势 .txt` |
| 📄 `records.vue` |

</details>

---

接下来，让我看看"我的"页面中的转入转出逻辑：

---

<details>
            <summary>Listed directory src/pages/my • **15** results</summary>
        
| Name |
|-------|
| 📄 `customer-service.vue` |
| 📄 `index.vue` |
| 📄 `wallet.vue` |
| 📄 `wechat-payment-setting.vue` |
| 📄 `withdraw.vue` |
| 📄 `identity-verify.vue` |
| 📄 `reset-password.vue` |
| 📄 `reset-withdraw-password.vue` |
| 📄 `settings.vue` |
| 📄 `bank-account-apply.vue` |
| 📄 `bank-cards.vue` |
| 📄 `alipay-accounts.vue` |
| 📄 `alipay-payment-setting.vue` |
| 📄 `announcement-detail.vue` |
| 📄 `announcements.vue` |

</details>

---

我需要先查看交易所的货币卖出和股权出售的代码。先看看 exchange.vue：

---

Read file: src/pages/trading/exchange.vue

---

我需要查看交易所的货币卖出和股权出售的处理逻辑：

---

Read file: src/pages/trading/exchange.vue

---

让我继续查看卖出货币和出售股权的逻辑：

---

Read file: src/pages/trading/exchange.vue

---

现在我需要查看"我的"页面中点击转入转出时的确认窗口实现：

---

Read file: src/pages/my/index.vue

---

让我继续查看"我的"页面中的转入转出确认窗口实现：

---

Read file: src/pages/my/index.vue

---

让我继续查看"我的"页面中的转入转出确认窗口实现：

---

Read file: src/pages/my/index.vue

---

现在让我查看交易所的货币卖出和股权出售的处理逻辑中是否有银行卡检查：

---

Read file: src/pages/trading/exchange.vue

---

我需要查看交易详情页面，看看货币卖出和股权出售的实际处理逻辑：

---

Read file: src/pages/trading/trade-detail.vue

---

让我查看交易详情页面中的交易确认逻辑：

---

Read file: src/pages/trading/trade-detail.vue

---

让我查看交易详情页面中的交易确认逻辑的剩余部分：

---

Read file: src/pages/trading/trade-detail.vue

---

让我查看股权出售弹窗组件：

---

<details>
            <summary>Searched codebase "SellEquityPopup" • **1** results</summary>
        
| File |
|------|
| `undefined` |

</details>

---

Read file: src/components/equity/SellEquityPopup.vue

---

现在我了解了交易所的货币卖出和股权出售功能，以及"我的"页面中转入转出时的确认窗口实现。我需要修改交易所中的货币卖出和股权出售逻辑，增加银行卡检查。

让我先修改货币卖出功能：

---

```diff
      return
    }
+ 
+   // 如果是卖出操作，检查银行卡状态
+   if (!isTypeBuy.value) {
+     try {
+       // 显示加载状态
+       uni.showLoading({
+         title: '检查中...',
+       })
+ 
+       // 从API获取最新的银行卡状态
+       const { checkBankCardStatusAPI } = await import('@/service/index/bankcard')
+       const res = await checkBankCardStatusAPI()
+       uni.hideLoading()
+ 
+       if (res.status === 'success' && res.data) {
+         // 使用类型断言处理响应数据
+         const statusData = res.data as any
+         const hasBankCard = statusData.has_bank_card
+ 
+         // 更新本地存储的用户银行卡状态
+         userStore.setUserInfo({
+           ...userStore.userInfo,
+           has_bank_card: hasBankCard,
+         })
+ 
+         // 如果用户没有开通银行卡，则提示用户先开通
+         if (!hasBankCard) {
+           uni.showModal({
+             title: '提示',
+             content: '卖出货币需要先开通银行卡，是否立即前往开通？',
+             confirmText: '去开通',
+             cancelText: '取消',
+             success: (res) => {
+               if (res.confirm) {
+                 // 跳转到银行卡开户申请页面
+                 uni.navigateTo({
+                   url: '/pages/my/bank-account-apply',
+                 })
+               }
+             },
+           })
+           return
+         }
+       }
+     } catch (error) {
+       uni.hideLoading()
+       console.error('获取银行卡状态失败:', error)
+ 
+       // 发生错误时降级使用本地状态
+       if (!userStore.userInfo.has_bank_card) {
+         uni.showModal({
+           title: '提示',
+           content: '卖出货币需要先开通银行卡，是否立即前往开通？',
+           confirmText: '去开通',
+           cancelText: '取消',
+           success: (res) => {
+             if (res.confirm) {
+               // 跳转到银行卡开户申请页面
+               uni.navigateTo({
+                 url: '/pages/my/bank-account-apply',
+               })
+             }
+           },
+         })
+         return
+       }
+     }
+   }
  
    // 输入验证
```

---

现在我需要修改股权出售功能：

---

```diff
  
  // 处理出售股权操作
- const handleSellEquity = () => {
+ const handleSellEquity = async () => {
    if (myEquity.value <= 0) {
      uni.showToast({
```

```diff
      return
    }
-   sellEquityPopup.value.open()
+ 
+   try {
+     // 显示加载状态
+     uni.showLoading({
+       title: '检查中...',
+     })
+ 
+     // 从API获取最新的银行卡状态
+     const { checkBankCardStatusAPI } = await import('@/service/index/bankcard')
+     const res = await checkBankCardStatusAPI()
+     uni.hideLoading()
+ 
+     if (res.status === 'success' && res.data) {
+       // 使用类型断言处理响应数据
+       const statusData = res.data as any
+       const hasBankCard = statusData.has_bank_card
+ 
+       // 更新本地存储的用户银行卡状态
+       userInfoStore.setUserInfo({
+         ...userInfoStore.userInfo,
+         has_bank_card: hasBankCard,
+       })
+ 
+       // 如果用户没有开通银行卡，则提示用户先开通
+       if (!hasBankCard) {
+         uni.showModal({
+           title: '提示',
+           content: '出售股权需要先开通银行卡，是否立即前往开通？',
+           confirmText: '去开通',
+           cancelText: '取消',
+           success: (res) => {
+             if (res.confirm) {
+               // 跳转到银行卡开户申请页面
+               uni.navigateTo({
+                 url: '/pages/my/bank-account-apply',
+               })
+             }
+           },
+         })
+         return
+       }
+ 
+       // 如果已开通银行卡，打开出售股权弹窗
+       sellEquityPopup.value.open()
+     }
+   } catch (error) {
+     uni.hideLoading()
+     console.error('获取银行卡状态失败:', error)
+ 
+     // 发生错误时降级使用本地状态
+     if (!userInfoStore.userInfo.has_bank_card) {
+       uni.showModal({
+         title: '提示',
+         content: '出售股权需要先开通银行卡，是否立即前往开通？',
+         confirmText: '去开通',
+         cancelText: '取消',
+         success: (res) => {
+           if (res.confirm) {
+             // 跳转到银行卡开户申请页面
+             uni.navigateTo({
+               url: '/pages/my/bank-account-apply',
+             })
+           }
+         },
+       })
+       return
+     }
+ 
+     // 如果本地状态显示已开通，则打开出售股权弹窗
+     sellEquityPopup.value.open()
+   }
  }
  
```

---

我已经完成了交易所货币卖出和股权出售功能的修改，添加了银行卡检查逻辑。现在，当用户尝试卖出货币或出售股权时，系统会先检查用户是否已开通银行卡：

1. 在货币卖出功能中（`trade-detail.vue`）：
   - 添加了银行卡状态检查
   - 如果用户没有开通银行卡，会显示确认弹窗提示"卖出货币需要先开通银行卡，是否立即前往开通？"
   - 用户点击"去开通"会跳转到银行卡开户申请页面

2. 在股权出售功能中（`exchange.vue`）：
   - 添加了银行卡状态检查
   - 如果用户没有开通银行卡，会显示确认弹窗提示"出售股权需要先开通银行卡，是否立即前往开通？"
   - 用户点击"去开通"会跳转到银行卡开户申请页面

这些修改与"我的"页面中点击转入转出时的确认窗口逻辑一致，使用了相同的弹窗样式和交互方式。当用户没有开通银行卡时，会引导用户去开通银行卡，确保用户在卖出货币或股权后能够正常收款。

---

_**User**_

能不能将是否开通银行卡的状态信息存储到store中，如果没有开通银行卡再发送请求获取最新的数据，然后该信息跟普通的用户信息一样，都需要退出后清空

---

_**Assistant**_



---

