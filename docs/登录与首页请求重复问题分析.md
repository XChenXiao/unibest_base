# 登录与首页请求重复问题分析

## 问题概述

在用户登录成功后跳转到首页的过程中，发现存在重复的API请求，这会造成不必要的网络开销和服务器压力。

## 重复请求分析

### 1. 用户信息请求重复

**登录时：**

- `src/pages/login/password.vue:167` - `userStore.fetchUserInfo()`

**首页时：**

- `src/pages/index/index.vue:127` - `userManagerStore.refreshBasicUserData()`
- 最终调用 `src/store/modules/user.ts:85` - `fetchUserInfo()`

**API端点：** `/api/user/info`

### 2. 实名认证状态请求重复

**登录时：**

- 通过用户信息接口返回的 `is_verified` 和 `verification_status` 字段

**首页时：**

- `src/pages/index/index.vue:285` - `verificationStore.fetchVerificationStatus()`
- 调用 `src/service/index/verification.ts` - `getVerificationStatusAPI()`

**API端点：** `/api/verification/status`

### 3. 货币数据获取重复风险

**登录时：**

- `src/pages/login/password.vue:172` - `currencyStore.fetchUserCurrencies(true)`

**首页及其他页面：**

- 多个页面都可能调用用户货币数据获取

## 已实施的优化方案

### 1. 登录流程优化

移除了登录成功后的用户信息请求：

```typescript
// 登录成功后只获取必要的数据，避免与首页重复请求
await Promise.all([
  // 获取平台功能开关设置（登录时强制更新）
  platformStore.fetchPlatformSettings(true),
  // 获取银行卡开户预存金
  appStore.fetchBankCardOpenFee(),
  // 获取用户货币数据
  currencyStore.fetchUserCurrencies(true),
])
```

### 2. 首页显示逻辑优化

添加了来源页面检测，避免从登录页面跳转时的重复请求：

```typescript
// 检查是否是从登录页面跳转而来，如果是则跳过数据刷新避免重复请求
const pages = getCurrentPages()
const fromLogin = pages.length > 1 && pages[pages.length - 2]?.route?.includes('login')

if (!fromLogin) {
  // 每次页面激活时只刷新基本用户信息，不包括银行卡和团队信息
  refreshBasicUserData()
} else {
  console.log('从登录页面跳转而来，跳过用户数据刷新避免重复请求')
}
```

## 进一步优化建议

### 1. 全局请求去重机制

建议在HTTP工具类中实现请求去重机制：

```typescript
// 请求缓存和去重
const pendingRequests = new Map()

export const http = <T>(options: CustomRequestOptions) => {
  const requestKey = `${options.method || 'GET'}_${options.url}_${JSON.stringify(options.data || {})}`

  // 如果相同请求正在进行中，返回相同的Promise
  if (pendingRequests.has(requestKey)) {
    return pendingRequests.get(requestKey)
  }

  // 创建新请求
  const requestPromise = uni.request(options)
  pendingRequests.set(requestKey, requestPromise)

  // 请求完成后清除缓存
  requestPromise.finally(() => {
    pendingRequests.delete(requestKey)
  })

  return requestPromise
}
```

### 2. Store数据缓存优化

在各个Store中实现更智能的缓存机制：

```typescript
// 最小更新间隔
const MIN_UPDATE_INTERVAL = 5 * 60 * 1000 // 5分钟

const fetchUserInfo = async (forceUpdate = false) => {
  const lastUpdateTime = uni.getStorageSync('userInfoUpdateTime') || 0
  const now = Date.now()

  // 如果不是强制更新且在最小更新间隔内，则跳过
  if (!forceUpdate && now - lastUpdateTime < MIN_UPDATE_INTERVAL) {
    console.log('用户信息在有效期内，跳过请求')
    return true
  }

  // 执行实际请求...
}
```

### 3. 页面间通信优化

使用 uni-app 的事件总线或 Pinia 的状态管理，在登录成功后通知首页数据已更新：

```typescript
// 登录成功后
uni.$emit('userDataUpdated', { source: 'login' })

// 首页监听
uni.$on('userDataUpdated', (data) => {
  if (data.source === 'login') {
    // 跳过数据刷新
    skipDataRefresh = true
  }
})
```

## 预期效果

通过以上优化，预计可以：

1. 减少 30-50% 的重复API请求
2. 提升登录到首页的加载速度
3. 降低服务器负载
4. 改善用户体验

## 监控建议

建议添加请求统计和监控：

1. 记录每个API的调用次数和频率
2. 监控重复请求的发生率
3. 定期分析和优化高频请求接口
